<!DOCTYPE html>
<html class="writer-html5" lang="ru" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Архитектура платформы &mdash; документация МПК Пересвет 0.4</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/sphinxcontrib-httpexample.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=11064190"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/sphinxcontrib-httpexample.js"></script>
        <script src="_static/translations.js?v=29b1f277"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="genindex.html" />
    <link rel="search" title="Поиск" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/logo_middle_text.png" class="logo" alt="Логотип"/>
          </a>
              <div class="version">
                0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" aria-label="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <p class="caption" role="heading"><span class="caption-text">Содержание:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="description.html">Описание</a></li>
<li class="toctree-l1"><a class="reference internal" href="terms.html">Используемые термины</a></li>
<li class="toctree-l1"><a class="reference internal" href="components.html">Компоненты системы</a></li>
<li class="toctree-l1"><a class="reference internal" href="historical_data.html">Исторические данные</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Установка</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Примеры работы с платформой</a></li>
<li class="toctree-l1"><a class="reference internal" href="grafana/grafana_integration.html">Создание экранов в Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">МПК Пересвет</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Архитектура платформы</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/architecture.rst.txt" rel="nofollow"> Просмотреть исходный код страницы</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>Архитектура платформы<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<section id="id2">
<h2>Общее описание<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>Архитектура платформы обуславливается, в значительной степени, создаваемой
ей моделью технического объекта.</p>
<p>Модель технического объекта состоит из двух частей: статической и динамической.
Статическая модель описывает сущности и экземпляры этих сущностей,
а динамическая - процессы, протекающие между экземплярами сущностей.</p>
</section>
<section id="id3">
<h2>Статическая модель<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>Статическая модель технических объектов, особенно в промышленности, хорошо
описывается иерархической структурой. К примеру:</p>
<p><code class="docutils literal notranslate"><span class="pre">Предприятие</span></code> → <code class="docutils literal notranslate"><span class="pre">Цех</span></code> → <code class="docutils literal notranslate"><span class="pre">Участок</span></code> →
<code class="docutils literal notranslate"><span class="pre">Технологическая</span> <span class="pre">линия</span></code> → <code class="docutils literal notranslate"><span class="pre">Агрегат</span></code>.</p>
<p>Поэтому в архитектуре появляется LDAP-сервер, с помощью которого
строится иерархия.</p>
<figure class="align-center" id="id23">
<img alt="_images/architecture_01.png" src="_images/architecture_01.png" />
<figcaption>
<p><span class="caption-text">LDAP-сервер</span><a class="headerlink" href="#id23" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Каждый узел в иерархии LDAP-сервера имеет свой определённый класс.
На рисунке ниже представлена иерархия узлов.</p>
<p>В скобках указан класс узла.</p>
<figure class="align-center" id="id24">
<img alt="_images/architecture_02.png" src="_images/architecture_02.png" />
<figcaption>
<p><span class="caption-text">Иерархия</span><a class="headerlink" href="#id24" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>На рисунке выше показан пример иерархии. Белыми квадратами показаны экземпляры
сущности <code class="docutils literal notranslate"><span class="pre">object</span></code> (класс в иерархии - <code class="docutils literal notranslate"><span class="pre">prsObject</span></code>), голубыми - теги,
красными - тревоги (alerts), зелёными - методы.</p>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Имена всех классов в иерархии строятся по принципу: <code class="docutils literal notranslate"><span class="pre">prs&lt;Имя</span> <span class="pre">сущности&gt;</span></code>.
Префикс <code class="docutils literal notranslate"><span class="pre">prs</span></code> облегчает фильтрацию классов, добавленных в схему сервера
платформой.
Имена атрибутов также имеют префикс <code class="docutils literal notranslate"><span class="pre">prs</span></code>.</p>
</div>
<ol class="arabic simple">
<li><p>Главный узел - <code class="docutils literal notranslate"><span class="pre">Участок</span> <span class="pre">металлообработки</span></code>. Класс - <code class="docutils literal notranslate"><span class="pre">prsObject</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Участок</span></code> содержит два тега:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Суммарная</span> <span class="pre">мощность</span></code> (всех станков на участке);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Температура</span> <span class="pre">помещения</span></code>.</p></li>
</ul>
</li>
<li><p>Тег <code class="docutils literal notranslate"><span class="pre">Участок</span> <span class="pre">металлообработки.Суммарная</span> <span class="pre">мощность</span></code> имеет метод для
вычисления суммы мощностей всех станков на участке.</p></li>
<li><p>Тег <code class="docutils literal notranslate"><span class="pre">Участок</span> <span class="pre">металлообработки.Температура</span> <span class="pre">помещения</span></code> имеет тревогу
<code class="docutils literal notranslate"><span class="pre">Превышение</span> <span class="pre">температуры</span></code>, которая срабатывает при превышении некоторого
установленного значения.</p></li>
<li><p>У объекта <code class="docutils literal notranslate"><span class="pre">Участок</span></code> - два дочерних объекта: <code class="docutils literal notranslate"><span class="pre">Станок</span> <span class="pre">1</span></code> и <code class="docutils literal notranslate"><span class="pre">Станок</span> <span class="pre">2</span></code>.</p></li>
<li><p>Каждый станок имеет два тега:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Потребляемая</span> <span class="pre">мощность</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ток</span> <span class="pre">фазы</span></code>.</p></li>
</ul>
</li>
<li><p>Tег <code class="docutils literal notranslate"><span class="pre">Ток</span> <span class="pre">фазы</span></code> имеет тревогу <code class="docutils literal notranslate"><span class="pre">Превышение</span> <span class="pre">тока</span></code>, которая, в свою очередь,
имеет метод <code class="docutils literal notranslate"><span class="pre">Оповещение</span></code>.</p></li>
</ol>
<p>Таким образом, в примере иерархии содержатся экземпляры четырёх сущностей:
<code class="docutils literal notranslate"><span class="pre">objects</span></code>, <code class="docutils literal notranslate"><span class="pre">tags</span></code>, <code class="docutils literal notranslate"><span class="pre">alerts</span></code>, <code class="docutils literal notranslate"><span class="pre">methods</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>В иерархии LDAP-сервера содержатся сущности, относящиеся не столько к модели
самого технического объекта, сколько к модели информационной системы. Это
такие сущности, как: хранилища данных (dataStorages), коннекторы (connectors),
расписания (schedules).</p>
</div>
</section>
<section id="id4">
<h2>Сервисы<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<p>Каждая сущность, присутствующая в иерархии, управляется своим сервисом.</p>
<figure class="align-center" id="id25">
<img alt="_images/architecture_03.png" src="_images/architecture_03.png" />
<figcaption>
<p><span class="caption-text">Сервисы</span><a class="headerlink" href="#id25" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>В действительности, каждый сервис - это, в общем случае, набор из четырёх
независимых микросервисов:</p>
<figure class="align-center" id="id26">
<img alt="_images/architecture_04.png" src="_images/architecture_04.png" />
<figcaption>
<p><span class="caption-text">Микросервисы</span><a class="headerlink" href="#id26" title="Link to this image"></a></p>
</figcaption>
</figure>
<section id="api-crud">
<h3>&lt;сущность&gt;_api_crud<a class="headerlink" href="#api-crud" title="Link to this heading"></a></h3>
<p>Микросервис, принимающий от пользователя или, в общем, от любых внешних
клиентов, запросы на создание, чтение, обновление, удаление экземпляров
сущности (команды CRUD).</p>
<p>Главная задача этого микросервиса - принять запрос от клиента и проверить
корректность параметров запроса (в случае, если миросервис реализован
на языке Python, то удобно для этих целей пользоваться модулем <code class="docutils literal notranslate"><span class="pre">pydantic</span></code>).</p>
<p>Вторая задача - отправить соответствующий запрос микросервису
<code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_model_crud</span></code>:</p>
<figure class="align-center" id="id27">
<img alt="_images/architecture_05.png" src="_images/architecture_05.png" />
<figcaption>
<p><span class="caption-text">&lt;сущность&gt;_api_crud</span><a class="headerlink" href="#id27" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Выделение описанной функциональности в отдельный микросервис облегчает
управление версиями API, позволяя, в том числе, работать одновременно
нескольким версиям. Вопрос только в запуске/остановке соответствующего
микросервиса.</p>
</section>
<section id="model-crud">
<h3>&lt;сущность&gt;_model_crud<a class="headerlink" href="#model-crud" title="Link to this heading"></a></h3>
<p>Микросервис, работающий с узлами сущности в иерархии. Именно этот сервис
реализует непосредственную работу с иерархической моделью, взаимодействуя
с LDAP-сервером.</p>
<figure class="align-center" id="id28">
<img alt="_images/architecture_06.png" src="_images/architecture_06.png" />
<figcaption>
<p><span class="caption-text">&lt;сущность&gt;_model_crud</span><a class="headerlink" href="#id28" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="app">
<h3>&lt;сущность&gt;_app<a class="headerlink" href="#app" title="Link to this heading"></a></h3>
<p>Иерархическая модель - не вещь в себе. Узлы в ней определяют, как функционирует
модель технического объекта.
То есть микросервис <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_app</span></code> определяет ту функциональность, ради
которой экземпляры сущности и создаются.
Например, для тегов это, в первую очередь, функции записи/чтения данных.
Для тревог - функциональность по инициации/квитированию/прападанию тревог.</p>
<p>Таким образом, сервис <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_app</span></code> читает из иерархии описания
узлов соответствующего типа и работает согласно этим описаниям.
Например, к тегу <code class="docutils literal notranslate"><span class="pre">Температура</span> <span class="pre">помещения</span></code> привязана тревога
<code class="docutils literal notranslate"><span class="pre">Превышение</span> <span class="pre">температуры</span></code>. Так вот именно сервис <code class="docutils literal notranslate"><span class="pre">alerts_app</span></code> будет
отслеживать значение температуры и генерировать, при необходимости, тревогу.</p>
<figure class="align-center" id="id29">
<img alt="_images/architecture_07.png" src="_images/architecture_07.png" />
<figcaption>
<p><span class="caption-text">&lt;сущность&gt;_app</span><a class="headerlink" href="#id29" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="app-api">
<h3>&lt;сущность&gt;_app_api<a class="headerlink" href="#app-api" title="Link to this heading"></a></h3>
<p>Микросервис предоставляет клиентам доступ к функциональности сервиса
<code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_app</span></code>. В случае тегов - это команды <code class="docutils literal notranslate"><span class="pre">data/set</span></code>, <code class="docutils literal notranslate"><span class="pre">data/get</span></code>.</p>
<p>В случае тревог - команды квитирования, получения списка активных тревог и
т.д.</p>
<figure class="align-center" id="id30">
<img alt="_images/architecture_08.png" src="_images/architecture_08.png" />
<figcaption>
<p><span class="caption-text">&lt;сущность&gt;_app_api</span><a class="headerlink" href="#id30" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="id5">
<h3>Базовые сущности, входящие в ядро МПК Пересвет<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<section id="id6">
<h4>Объекты<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">objects</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsObject</span></code>.</p>
</div>
<p>Базовый узел в иерархии. Каждый узел сущности <code class="docutils literal notranslate"><span class="pre">objects</span></code> может иметь
любое количество дочерних узлов этой же сущности. Таким образом обеспечивается
возможность создания иерархии объектов любой сложности.</p>
</section>
<section id="id7">
<h4>Теги<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">tags</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsTag</span></code></p>
</div>
<p>Тег - это параметр объекта. Например: температура, давление, расход, и т.д.</p>
<p>Теги бывают обычные, в которые данные поступают из внешних источников
(датчики, SCADA, ручной ввод и т.д.), а также рассчитываемые.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong></p>
<ul class="simple">
<li><p>тег <code class="docutils literal notranslate"><span class="pre">Потребляемая</span> <span class="pre">мощность</span></code> у объекта <code class="docutils literal notranslate"><span class="pre">Котёл</span></code> в системе «умного дома» -
обычный тег, данные в который поступают от «умной» розетки по протоколу
«ZigBee»;</p></li>
<li><p>тег <code class="docutils literal notranslate"><span class="pre">Общий</span> <span class="pre">расход</span> <span class="pre">газа</span> <span class="pre">на</span> <span class="pre">собственные</span> <span class="pre">нужды</span></code> объекта <code class="docutils literal notranslate"><span class="pre">Промысел</span></code> -
вычисляемый и является суммой затрат газа на котельные промысла,
а также потерь на факел;</p></li>
</ul>
<p>Но ничто не мешает тегу быть одновременно и обычным, и рассчитываемым. То есть
данные в тег могут поступать из внешнего источника, редактироваться
пользователем, а также, в определённых случаях, рассчитываться.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p>Новое значение тега может инициировать расчёт значений других тегов. В таком
случае в иерархии указывается, расчёт каких тегов инициируется изменением
значения данного тега.</p>
</section>
<section id="id8">
<h4>Тревоги<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">alerts</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsAlert</span></code></p>
</div>
<p>Тревога - событие, возникающее при определённых условиях. Тревоги применяются,
в основном, для сигнализации о каких-то событиях (не обязательно критичных и
плохих, как может показаться из названия сущности, просто так сложилось
в АСУТП).</p>
<p>События возникновения тревог, также как и события изменения тегов и
события расписаний, могут запускать выполнение определённых процессов.</p>
<p>Экземпляр сущности <code class="docutils literal notranslate"><span class="pre">alerts</span></code> обязательно привязан к какому-либо тегу.
Каждое изменение значения тега, к которому привязаны тревоги, будет приводить к
пересчету условий возникновения тревог. Если условие выполняется, то произойдёт
событие возникновения тревоги.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong></p>
<p>Объект «Паропровод». У него есть тег - «Температура пара». К тегу привязана
тревога «Превышение температуры». В условиях тревоги указано, что она должна
возникать при превышении значения температуры в 120 ° C.</p>
<p>Таким образом, каждое изменение тега будет приводить к проверке условия, что
новое значение тега превышает значение в 120 ° C. Если условие выполняется,
то произойдёт событие возникновения тревоги.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p>Обычно в АСУТП тревоги бывают четырёх типов: LOLO-LO-HI-HIHI.</p>
<p>То есть:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LOLO</span></code> - нижний критичный уровень;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LO</span></code> - нижний предупредительный уровень;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HI</span></code> - верхний предупредительный уровень;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HIHI</span></code> - верхний критичный уровень.</p></li>
</ul>
<p>В отличие от принятой практики, МПК Пересвет допускает создание любого
количества тревог, привязанных к тегу.</p>
<p>Кроме того, существуют дополнительные возможности при создании тревог:</p>
<ul class="simple">
<li><p>отложенные тревога;
тревога, которая возникает спустя некоторое время после изменения значения
тега на критичное</p></li>
</ul>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong>
Тревога должна возникать, если температура пара в паропроводе превышает
120 ° C на протяжении не менее двух минут. Иначе ситуация считается
нормальной.</p>
<embed>
   <hr color="#000000" size="1">
</embed><ul class="simple">
<li><p>сложные тревоги;
это такие тревоги, которые имеют сложные условия возникновения; к таким
тревогам привязывается вычислительный метод, который определяет, должна ли
возникать тревога; такие тревоги позволяют учитывать значения нескольких
тегов, а также вообще любые дополнительные условия.</p></li>
</ul>
<p>Тревоги могут быть квитируемые и не квитируемые.</p>
<p>Квитируемые тревоги - это такие тревоги, которые не исчезают до тех пор, пока
пользователь не отметит, что он их заметил (квитировал)</p>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong>
Тревога «Превышение температуры» у паропровода должна быть обязательно замечена
оператором, потому как возникновение такой тревоги влечёт за собой
необходимость проведения определённых работ по обслуживанию паропровода.</p>
<p>Поэтому даже после снижения температуры ниже 120 ° C тревога не пропадёт,
пока оператор не отметит, что заметил эту тревогу.</p>
<embed>
   <hr color="#000000" size="1">
</embed></section>
<section id="id9">
<h4>Методы<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">methods</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsMethod</span></code></p>
</div>
<p>Методы применяются:</p>
<ul class="simple">
<li><p>для вычисления значений тегов;</p></li>
<li><p>для вычисления условий возникновения аварий;</p></li>
<li><p>привязываются к событиям расписания, инициируя, таким образом, выполнение
определённых вычислений/действий по расписанию;</p></li>
<li><p>для запуска каких-либо процессов (рассылка почты, диспетчерские процессы
при возникновении определённых событий и т.д.)</p></li>
</ul>
</section>
<section id="id10">
<h4>Хранилища данных<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">dataStorages</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsDataStorage</span></code></p>
</div>
<p>Сущность относится не к модели технического объекта, а к модели информационной
системы.</p>
<p>Хранилище данных - это база данных, в которой хранятся исторические значения
тегов и тревог.</p>
<p>В настоящий момент поддерживаются <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a>
и <a class="reference external" href="https://victoriametrics.com/">Victoriametrics</a>.</p>
<p>При написании соответствующего драйвера могут поддерживаться любые виды
хранилищ.</p>
<p>Платформа поддерживает возможность одновременной работы нескольких хранилищ,
причём разных типов.</p>
</section>
<section id="id11">
<h4>Коннекторы<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">connectors</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsConnector</span></code></p>
</div>
<p>Коннектор - специальная программа, являющаяся поставщиком данных от какого-либо
источника.</p>
<p>Обычно реализует собой возможность чтения данных по какому-либо протоколу
(modbus, OPC и т.д.).</p>
<p>Коннектор устанавливается как можно ближе к источнику данных,
инициирует связь с платформой по протоколу Websocket и передаёт в платформу
счианные из источника данных значения.</p>
<p>В свою очередь, принимает от платформы по этому же каналу сообщения об
измнениях параметров тегов и т.д.</p>
</section>
<section id="id12">
<h4>Константы<a class="headerlink" href="#id12" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">constants</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsConstant</span></code></p>
</div>
<p>Константы - определённые значения, используемые в рамках всей системы.
Передаются в вычислительные методы.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong> константа <code class="docutils literal notranslate"><span class="pre">pieColors</span></code>: словарь, в котором указывается набор
цветов для отображения «пирогов» в отчётах.</p>
<embed>
   <hr color="#000000" size="1">
</embed></section>
<section id="id13">
<h4>Расписания<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Сущность <code class="docutils literal notranslate"><span class="pre">schedules</span></code>, класс в иерархии <code class="docutils literal notranslate"><span class="pre">prsSchedule</span></code></p>
</div>
<p>Расписание определяет моменты возникновения событий, привязанных ко времени.
Эти события могут вызывать выполнение определённых методов:</p>
<ul class="simple">
<li><p>расчёт вычисляемых тегов;</p></li>
<li><p>запуск выполнения внешних методов.</p></li>
</ul>
</section>
</section>
<section id="id14">
<h3>«Комплекты» сервисов<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>Необязательно для каждой сущности должен существовать комплект из четырёх
микросервисов.</p>
<embed>
   <hr color="#000000" size="1">
</embed><p><strong>Например:</strong></p>
<p>Константы - это сущность <code class="docutils literal notranslate"><span class="pre">constants</span></code>. Имеет только два сервиса:
<code class="docutils literal notranslate"><span class="pre">constants_api_crud</span></code> - API для создания-чтения-обновления-удаления констант и
<code class="docutils literal notranslate"><span class="pre">constants_model_crud</span></code> - собственно, сам функционал для работы с иерархией.
Никакой собственной функциональности у констант нет. Они существуют только для
того, чтобы передаваться в методы. То есть, используются при работе сущности
<code class="docutils literal notranslate"><span class="pre">methods</span></code>.</p>
<p>Другой пример - сущность <code class="docutils literal notranslate"><span class="pre">connectors</span></code>, коннекторы. Имеет три микросервиса:
<code class="docutils literal notranslate"><span class="pre">connectors_api_crud</span></code>, <code class="docutils literal notranslate"><span class="pre">connectors_model_crud</span></code>, <code class="docutils literal notranslate"><span class="pre">connectors_app</span></code>.
Микросервиса <code class="docutils literal notranslate"><span class="pre">connectors_app_api</span></code> нет, так как <code class="docutils literal notranslate"><span class="pre">connectors_app</span></code>
не предоставляет никакой функциональности внешним клиентам. Задача
<code class="docutils literal notranslate"><span class="pre">connectors_app</span></code> - поддержание связи по веб-сокету с коннекторами и приём
от них данных с дальнейшей отсылкой в платформу.</p>
<p>Ещё один пример - хранилища данных, сущность <code class="docutils literal notranslate"><span class="pre">dataStorages</span></code>. Также не имеет
сервиса <code class="docutils literal notranslate"><span class="pre">datastorages_app_api</span></code>, но имеет много разных сервисов
<code class="docutils literal notranslate"><span class="pre">datastorages_app</span></code>, каждый из которых реализует свой тип базы данных.</p>
<embed>
   <hr color="#000000" size="1">
</embed></section>
<section id="id15">
<h3>Другие сервисы<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<p>Платформа спроектирована таким образом, что допускает расширение списка
сущностей, которые могут присутствовать в статической модели и, соответственно,
внутри иерархии.</p>
<p>Для каждой новой сущности необходимо необходимо создать свой класс в схеме
LDAP-сервера и разработать комплект микросервисов, взяв за основу базовые
классы.</p>
<p>Экземпляры сущности в иерархии могут создаваться:</p>
<ol class="arabic">
<li><p>Внутри своего базового узла. Например:</p>
<ul class="simple">
<li><p>основная иерархия - модель технического объекта, строится внутри
узла <code class="docutils literal notranslate"><span class="pre">objects</span></code>;</p></li>
<li><p>список хранилищ данных - внутри узла <code class="docutils literal notranslate"><span class="pre">dataStorages</span></code>.</p></li>
</ul>
</li>
<li><p>Внутри базовой иерархии - модели технического объекта. Например:</p>
<ul class="simple">
<li><p>тревоги: тревоги могут создаваться только внутри узлов класса <code class="docutils literal notranslate"><span class="pre">prsTag</span></code>,
так как тревоги существуют только в привязке к тегам;</p></li>
<li><p>методы: могут быть привязаны к тегам или тревогам.</p></li>
</ul>
</li>
<li><p>Внутри своего базового узла или внутри базовой иерархии. Примером здесь
могут служить теги. Теги, чаще всего, создаются внутри основной иерархии,
в качестве дочерних узлов для узлов класса <code class="docutils literal notranslate"><span class="pre">prsObjects</span></code>.</p>
<p>Но также возможны простые случаи применения платформы, для автоматизации
совсем небольших объектов, где нет необходимости создавать иерархию
объектов, то есть для автоматизации достаточно создать несколько тегов.</p>
<p>В этом случае теги могут быть созданы линейным списком внутри узла <code class="docutils literal notranslate"><span class="pre">tags</span></code>.</p>
</li>
</ol>
</section>
</section>
<section id="id16">
<h2>Хранилища данных<a class="headerlink" href="#id16" title="Link to this heading"></a></h2>
<p>Значения тегов и тревог записываются в хранилища данных. В настоящий момент
поддерживаются два типа хранилищ: PostgreSQL и Victoriametrics.
Для поддержки нового типа хранилища необходимо написать соответствующий
микросервис.</p>
<figure class="align-center" id="id31">
<img alt="_images/architecture_09.png" src="_images/architecture_09.png" />
<figcaption>
<p><span class="caption-text">Хранилища данных</span><a class="headerlink" href="#id31" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Допускается одновременная работа нескольких хранилищ данных, как одного типа,
так и разных. Таким образом, можно хранить историю значений тегов и тревог
в разных хранилищах.</p>
</section>
<section id="id17">
<h2>Брокер очередей сообщений<a class="headerlink" href="#id17" title="Link to this heading"></a></h2>
<p>Таким образом, платформа представляет собой большое количество микросервисов.</p>
<p>Более того, одновременно может быть запущено несколько экземпляров каждого
микросервиса, причем на разных серверах. Этим реализуется масштабируемость
и высокая доступность (high availability) платформы.</p>
<p>Микросервисы работают не сами по себе, они взаимодействуют. Реализовывать
внутри каждого микросервиса связь со всеми необходимыми ему микросервисами -
непродуктивно.</p>
<p>Для реализации общения между микросервисами в архитектуру платформы добавлен
брокер очередей сообщений - <a class="reference external" href="www.rabbitmq.com">RabbitMQ</a>.</p>
<figure class="align-center" id="id32">
<img alt="_images/architecture_10.png" src="_images/architecture_10.png" />
<figcaption>
<p><span class="caption-text">Брокер сообщений</span><a class="headerlink" href="#id32" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Для понимания системы общения внутри платформы необходимо прочитать
(не обязательно полное) руководство на RabbitMQ, с тем, чтобы хорошо
разбираться в терминах:</p>
<ul class="simple">
<li><p>обменник (exchange), а также в их типах (FANOUT, DIRECT, TOPIC);</p></li>
<li><p>очередь (queue);</p></li>
<li><p>привязка и ключ маршрутизации (binding, routing key).</p></li>
</ul>
</div>
<section id="id18">
<h3>Обменники сервисов<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>Как упоминалось выше в разделе <a class="reference internal" href="#id4">Сервисы</a>, для каждой сущности создаётся,
в общем случае, группа из четырёх микросервисов.</p>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Рекомендуемый подход:
каждая группа сервисов для сущности имеет свой отдельный обменник.</p>
</div>
<p>Каждый микросервис, стартуя, создаёт в этом обменнике очередь, в которой будет
ожидать управляющие команды. Также через этот обменник сервис публикует
свои сообщения, указывая в качестве ключа маршрутизации указанную
в конфигурации строку.</p>
<section id="id19">
<h4>Конфигурирование<a class="headerlink" href="#id19" title="Link to this heading"></a></h4>
<p>Далее на рисунках показан рекомендуемый подход к конфигурированию системы
сообщений.</p>
<p>Начнём с группы сервисов <code class="docutils literal notranslate"><span class="pre">objects</span></code>.</p>
<figure class="align-center" id="id33">
<img alt="_images/exchanges_01.png" src="_images/exchanges_01.png" />
<figcaption>
<p><span class="caption-text">Сервис <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>.</span><a class="headerlink" href="#id33" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>На рисунке видим, что сервис <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>:</p>
<ol class="arabic simple">
<li><p>Публикует в обменник
<code class="docutils literal notranslate"><span class="pre">objects</span></code> свои сообщения с
<code class="docutils literal notranslate"><span class="pre">routing_key</span> <span class="pre">=</span> <span class="pre">objects_model_crud_publish</span></code>.</p></li>
<li><p>Создаёт очередь <code class="docutils literal notranslate"><span class="pre">objects_model_crud_consume</span></code> и делает ей привязку
с таким же именем. В этой очереди сервис ожидает сообщения.</p></li>
</ol>
<p>Таким образом, получаем следующую конфигурацию обменников для сервиса
<code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="c1"># блок &quot;публикаций&quot;</span>
   <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1"># главный обменник;</span>
      <span class="c1"># в следующих реализациях, возможно, потребуются дополнительные</span>
      <span class="c1"># обменники, они будут описаны в своих ключах</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="c1"># имя обменника</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="c1"># тип всех обменников - direct, но возможно, в классах-наследниках</span>
         <span class="c1"># потребуются другие типы, поэтому тип указываем явно</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="c1"># ключ маршрутизации по умолчанию, но, для большей гибкости,</span>
         <span class="c1"># также задаём его имя</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;objects_model_crud_publish&quot;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="c1"># блок &quot;потребления&quot;</span>
   <span class="s2">&quot;consume&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;queue_name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects_model_crud_consume&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;objects_model_crud_consume&quot;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Добавляем в группу сервис <code class="docutils literal notranslate"><span class="pre">objects_api_crud</span></code>:</p>
<figure class="align-center" id="id34">
<img alt="_images/exchanges_02.png" src="_images/exchanges_02.png" />
<figcaption>
<p><span class="caption-text">Сервис <code class="docutils literal notranslate"><span class="pre">objects_api_crud</span></code>.</span><a class="headerlink" href="#id34" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Логика та же, что и у предыдущего сервиса.</p>
<div class="admonition warning">
<p class="admonition-title">Предупреждение</p>
<p>На рисунке видно, что <code class="docutils literal notranslate"><span class="pre">objects_api_crud</span></code> может принимать
сообщения по протоколу HTTP(S) и из очереди.
В текущей реализации команды CRUD принимаются только по протоколу HTTP(S).</p>
</div>
<p>Конфигурация сервиса аналогична предыдущей, за исключением имён очередей
и ключей маршрутизации:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;objects_api_crud_publish&quot;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="s2">&quot;consume&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;queue_name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects_api_crud_consume&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;objects_api_crud_consume&quot;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Обратите внимание, что, так как сервис <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code> ожидает сообщения
от сервиса <code class="docutils literal notranslate"><span class="pre">objects_api_crud</span></code>, то к его consume-очереди
мы добавляем дополнительный ключ маршрутизации: <code class="docutils literal notranslate"><span class="pre">objects_api_crud_publish</span></code>.</p>
<p>Таким образом, конфигурация сервиса <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code> становится такой:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;objects_model_crud_publish&quot;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="s2">&quot;consume&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;queue_name&quot;</span><span class="p">:</span> <span class="s2">&quot;objects_model_crud_consume&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;objects_model_crud_consume&quot;</span><span class="p">,</span>
            <span class="s2">&quot;objects_api_crud_publish&quot;</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id20">
<h3>Логика сообщений при создании, обновлении и удалении узлов<a class="headerlink" href="#id20" title="Link to this heading"></a></h3>
<p>Рассмотрим следующую ситуацию.</p>
<p>Допустим, у нас есть иерархия и в этой иерархии - узел класса
<code class="docutils literal notranslate"><span class="pre">prsСущность_1</span></code>. Через некоторое время была создана группа сервисов
для работы с новой сущностью <code class="docutils literal notranslate"><span class="pre">Сущность_2</span></code>, причём узлы-экземпляры этой
сущности являются дочерними по отношению к узлам сущности <code class="docutils literal notranslate"><span class="pre">Сущность_1</span></code>.</p>
<p>Таким образом, <code class="docutils literal notranslate"><span class="pre">Сущность_2</span></code> разработана позже и <code class="docutils literal notranslate"><span class="pre">Сущность_1</span></code> ничего
не «знает» о наличии <code class="docutils literal notranslate"><span class="pre">Сущность_2</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Узел_1 (prsСущность_1)
 ├ Узел_2 (prsСущность_2)
 └ Узел_3 (prsСущность_2)
</pre></div>
</div>
<p>Далее допустим, что в сервис <code class="docutils literal notranslate"><span class="pre">Сущность_1_api_crud</span></code> приходит команда на
удаление узла <code class="docutils literal notranslate"><span class="pre">Узел_1</span></code>. Команда затем поступает в сервис
<code class="docutils literal notranslate"><span class="pre">Сущность_1_model_crud</span></code>, который и выполняет удаление узла.</p>
<p>При этом удаляется полностью вся иерархия под узлом <code class="docutils literal notranslate"><span class="pre">Узел_1</span></code>.</p>
<p>Соответственно, сервисы группы <code class="docutils literal notranslate"><span class="pre">Сущность_2</span></code> остаются в полном неведении
о том, что «их» узлы тоже удалены.</p>
<p>Не смотря на то, что сервис <code class="docutils literal notranslate"><span class="pre">Сущность_1_model_crud</span></code> посылает после удаления
узла сообщение c <code class="docutils literal notranslate"><span class="pre">&quot;action&quot;:</span> <span class="pre">&quot;deleted&quot;</span></code>, на которое подписан сервис
<code class="docutils literal notranslate"><span class="pre">Сущность_2_app</span></code>, <code class="docutils literal notranslate"><span class="pre">Сущность_2</span></code> не может корректно обработать удаление
«своих» узлов, так как они уже удалены из иерархии и информация о них
потеряна.</p>
<p>Для избежания этой коллизии процесс удаления узла сущности реализован
следующим образом.</p>
<ol class="arabic simple">
<li><p>При старте сервис <code class="docutils literal notranslate"><span class="pre">сущность_2_model_crud</span></code> уведомляет
сервис <code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud</span></code> о том,
что перед удалением или изменением узлов <code class="docutils literal notranslate"><span class="pre">Сущность_1</span></code> его, то есть
сервис <code class="docutils literal notranslate"><span class="pre">сущность_2_model_crud</span></code>, необходимо уведомить.</p></li>
<li><p>Сервис <code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud</span></code> хранит список заинтересованных сервисов.</p></li>
<li><p>Перед изменением или удалением «своего» узла сервис
<code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud</span></code> посылает запросы типа RPC всем подписавшимся
сервисам (ниже - пример последовательности запросов при удалении узла,
при этом в теле запроса указывается id удаляемого узла):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">may_delete</span></code>: Можно ли удалять узел? В ответе от каждого
заинтересованного сервиса должен прийти ответ: да или нет.
Если хотя бы один сервис пришлёт ответ «нет», то узел не будет удалён;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deleting</span></code>: в случае, если на предыдущее сообщение все заинтересованные
сервисы ответили «да», то посылается это сообщение, уведомляя все
заинтересованные сервисы о удалении узла <code class="docutils literal notranslate"><span class="pre">Узел_1</span></code>; в процессе обработки
этого сообщения все заинтересованные сервисы (<code class="docutils literal notranslate"><span class="pre">сущность_2_model_crud</span></code>)
корректно удаляют «свои» узлы из иерархии и отсылают ответ сервису
<code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud</span></code> о завершении работы по удалению своих узлов.</p></li>
</ul>
</li>
<li><p>После выполнения запроса <code class="docutils literal notranslate"><span class="pre">deleting</span></code>, дождавшись ответа от всех
заинтересованных подписчиков, сервис <code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud</span></code> удаляет
узел <code class="docutils literal notranslate"><span class="pre">Узел_1</span></code> и рассылает через свой обменник
<code class="docutils literal notranslate"><span class="pre">сущность_1_model_crud_pub</span></code> сообщение об удалении узла <code class="docutils literal notranslate"><span class="pre">Узел_1</span></code>.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Предупреждение</p>
<p>Остаётся проблема: если между запросами <code class="docutils literal notranslate"><span class="pre">may_delete</span></code> и <code class="docutils literal notranslate"><span class="pre">deleting</span></code>
произошло что-то, что накладывает дополнительные ограничения на удаление
узла. Например, произошла подписка нового сервиса.</p>
<p>Решение проблемы откладываем на будущие версии.</p>
</div>
<p>Рассмотрим сказанное выше на примере сервисов
<code class="docutils literal notranslate"><span class="pre">tags_model_crud</span></code> и <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>:</p>
<ol class="arabic">
<li><p>Сервис <code class="docutils literal notranslate"><span class="pre">tags_model_crud</span></code> получает сообщение о создании нового тега:</p>
<img alt="_images/subscribers_01.png" src="_images/subscribers_01.png" />
</li>
<li><p>В процессе обработки сообщения <code class="docutils literal notranslate"><span class="pre">tags_model_crud</span></code> создаёт в иерархии новые
узлы:</p>
<img alt="_images/subscribers_02.png" src="_images/subscribers_02.png" />
</li>
<li><p>…и посылает в обменник <code class="docutils literal notranslate"><span class="pre">objects</span></code> сообщение о подписке:</p>
<img alt="_images/subscribers_03.png" src="_images/subscribers_03.png" />
</li>
<li><p>Сервис <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>, получив это сообщение, добавляет в узел
<code class="docutils literal notranslate"><span class="pre">subscribers</span></code> узел <code class="docutils literal notranslate"><span class="pre">tags_model_crud_consume</span></code>:</p>
<img alt="_images/subscribers_04.png" src="_images/subscribers_04.png" />
</li>
<li><p>Теперь при изменении/удалении объекта «123» сервис <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>
посылает всем подписавшимся RPC-сообщения:</p>
<ol class="loweralpha">
<li><p><code class="docutils literal notranslate"><span class="pre">may_delete</span></code>. В теле сообщения указывается id объекта для удаления.
В поле <code class="docutils literal notranslate"><span class="pre">reply_to</span></code> <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code> указывает <code class="docutils literal notranslate"><span class="pre">routing_key</span></code>
для очереди, в которой будет ожидать ответ.</p>
<p>Получив сообщение <code class="docutils literal notranslate"><span class="pre">may_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">tags_model_crud</span></code> ищет теги,
привязанные к удаляемому объекту и определяет, можно ли их удалить. Для
этого он сам посылает сообщение
<code class="docutils literal notranslate"><span class="pre">may_delete</span></code> уже своим подписчикам, указывая удаляемые теги.</p>
<p>Если хотя бы от одного подписчика придёт ответ <code class="docutils literal notranslate"><span class="pre">no</span></code>, что означает,
что объект удалять нельзя, то процедура прервётся.</p>
</li>
<li><p>Если все подписчики прислали ответ <code class="docutils literal notranslate"><span class="pre">ok</span></code>, то <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code>
рассылает всем новое сообщение - <code class="docutils literal notranslate"><span class="pre">deleting</span></code>. Получив это сообщение,
<code class="docutils literal notranslate"><span class="pre">tags_model_crud</span></code> должен выполнить работу по удалению всех тегов
удаляемого объекта (при этом сам должен разослать сообщение
<code class="docutils literal notranslate"><span class="pre">deleting</span></code> всем своим подписчикам).</p></li>
<li><p>После того, как в ответ на <code class="docutils literal notranslate"><span class="pre">deleting</span></code> вернулись ответы <code class="docutils literal notranslate"><span class="pre">ok</span></code> от всех
подписчиков, <code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code> удаляет объет.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">objects_model_crud</span></code> посылает сообщение <code class="docutils literal notranslate"><span class="pre">deleted</span></code>.</p></li>
</ol>
</li>
</ol>
<p>Таким образом, сервис <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_model_crud</span></code> имеет следующую базовую
конфигурацию обменников:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1"># основной обменник, в который сервис шлёт свои сообщения</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="c1"># как правило - один обменник на всю группу сервисов</span>
         <span class="c1"># для одной сущности</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность&gt;_model_crud_publish&quot;</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="s2">&quot;consume&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1"># главный обменник, от которого сервис ждёт управляющие команды</span>
      <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
         <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность&gt;_model_crud_consume&quot;</span><span class="p">,</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность&gt;_model_crud_consume&quot;</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="c1"># блок описания обменников тех сущностей, на которые должен</span>
   <span class="c1"># подписаться сервис</span>
   <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1"># сущность, уведомления об изменение/удаление узлов которой</span>
      <span class="c1"># требуются сервису</span>
      <span class="s2">&quot;&lt;сущность_2&gt;&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="c1"># в этот обменник сервис будет посылать сообщение &quot;subscribe&quot;</span>
         <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность_2&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность_2&gt;_model_crud_consume&quot;</span>
         <span class="p">},</span>
         <span class="c1"># обменник, из которого сервис будет получать уведомления об</span>
         <span class="c1"># изменениях узлов</span>
         <span class="c1"># (к этому обменнику, с указанным routing_key будет привязана</span>
         <span class="c1"># главная очередь сервиса с управляющими командами)</span>
         <span class="s2">&quot;consume&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность_2&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;сущность_2&gt;_model_crud_publish&quot;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id21">
<h3>Типовые сообщения сервисов<a class="headerlink" href="#id21" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>В таблицах сообщений предполагаем следующее:</p>
<ol class="arabic">
<li><p>Обменник, в который публикует сообщения сервис, имеет имя <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;</span></code>.</p></li>
<li><p>Если в колонке <code class="docutils literal notranslate"><span class="pre">RPC</span></code> стоит плюс, значит, посылающий сообщение сервис
ожидает ответ. В этом случае у сообщения выставлены параметры
<code class="docutils literal notranslate"><span class="pre">reply_to</span></code> и <code class="docutils literal notranslate"><span class="pre">correlation_id</span></code>,
поэтому их не указываем в таблицах.</p></li>
<li><p>Формат тела сообщений (за исключением ответов при RPC):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;some_action&gt;&quot;</span><span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>где</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">action</span></code> - тип команды,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> - параметры команды</p></li>
</ul>
</li>
</ol>
</div>
<section id="id22">
<h4>&lt;сущность&gt;_model_crud<a class="headerlink" href="#id22" title="Link to this heading"></a></h4>
<p><strong>Publish</strong></p>
<p><strong>Consume</strong></p>
<p>Все сообщения для сервиса приходят в очередь <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_model_crud_consume</span></code>,
<code class="docutils literal notranslate"><span class="pre">routing_key</span> <span class="pre">=</span> <span class="pre">&lt;сущность&gt;_model_crud_consume</span></code>.</p>
<table class="docutils align-default" id="id35">
<caption><span class="caption-text">Сообщения, обрабатываемые сервисом <code class="docutils literal notranslate"><span class="pre">&lt;сущность&gt;_model_crud</span></code></span><a class="headerlink" href="#id35" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>action</p></th>
<th class="head"><p>RPC</p></th>
<th class="head"><p>Описание</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>subscribe</p></td>
<td><p><cite>-</cite></p></td>
<td><p>Сообщение приходит от другого сервиса, который заинтересован <br/>
в получении уведомлений о изменении/удалении определённых узлов</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><details>
<summary><a>Тело сообщения</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;some_routing_key&gt;&quot;</span>
         <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;id_1&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;id_2&quot;</span><span class="p">]</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</details>
<br/></td>
</tr>
<tr class="row-even"><td><p>unsubscribe</p></td>
<td><p><cite>-</cite></p></td>
<td><p>Сообщение приходит от другого сервиса, который сообщает <br/>
об отказе в получении уведомлений о изменении/удалении узлов</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><details>
<summary><a>Тело сообщения</a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span>
   <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;routing_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;some_routing_key&gt;&quot;</span>
         <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;id_1&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;id_2&quot;</span><span class="p">]</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</details>
<br/></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Авторские права 2024, ООО Матч Поинт Консалтинг. </p>
  </div>

  Собрано при помощи <a href="https://www.sphinx-doc.org/">Sphinx</a> с использованием
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">темы,</a>
    предоставленной <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>