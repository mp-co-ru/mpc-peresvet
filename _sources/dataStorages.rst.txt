.. include:: <isonum.txt>

.. |br| raw:: html

   <br/>

dataStorages (хранилища данных)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Группа сервисов для хранилищ данных.

Особенностью этой группы сервисов является то, что сервисов
``dataStorages_app`` может быть сколь угодно много: для каждого типа
хранилища свой сервис.

Более того, в процессе работы платформы могут подключаться дополнительные
типы хранилищ, неизвестные на момент старта.

Это несколько усложняет систему сообщений.

dataStorages_api_crud
"""""""""""""""""""""
Типовой сервис, реализующий блок команд CRUD API.

**Configuration**

Типовая конфигурация сервиса:

.. code:: python

    {
        # имя сервиса. сервисы *_mod_crud создают в иерархии узел с таким же именем
        svc_name: str = "dataStorages_api_crud"
        # строка коннекта к RabbitMQ
        amqp_url: str = "amqp://prs:********@rabbitmq/"
        # строка коннекта к OpenLDAP
        ldap_url: str = "ldap://ldap:389/cn=prs????bindname=cn=admin%2ccn=prs,X-BINDPW=********"

        # обменник для публикаций
        publish: dict = {
            "main": {
                "name": "dataStorages",
                "type": "direct",
                "routing_key": ["dataStorages_api_crud_publish"]
            }
        }
    }

**Publish**

.. table:: Сообщения, генерируемые сервисом ``dataStorages_api_crud``

   +-----------+----------------------------------+-----+---------------------------------+
   |  action   |        routing_key               | RPC | Какому сервису предназначено    |
   +===========+==================================+=====+=================================+
   | create    | <dataStorages>_api_crud_publish  | `+` | dataStorages_model_crud,        |
   |           |                                  |     | всем подписанным сервисам       |
   +-----------+----------------------------------+-----+---------------------------------+
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     <details>                                                                        |
   |     <summary><a>Описание</a></summary>                                               |
   |                                                                                      |
   |     Сообщение посылается как команда на создание нового хранилища данных в <br/>     |
   |     сервис <b>dataStorages_model_crud</b>                                            |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело сообщения</a></summary>                                         |
   |                                                                                      |
   |  .. code-block:: python                                                              |
   |                                                                                      |
   |     {                                                                                |
   |        "action": "create",                                                           |
   |        "data": {                                                                     |
   |           "attributes": {                                                            |
   |                # Необзяательный ключ. В случае отсутствия в качестве имени           |
   |                # будет использован id хранилища.                                     |
   |                "cn": "имя хранилища",                                                |
   |                # также необязательный ключ                                           |
   |                "description": "описание",                                            |
   |                "prsJsonConfigString": {                                              |
   |                    # Обязательный ключ. С таким "routing_key" будут посылаться       |
   |                    # сообщения, адресованные разным хранилищам.                      |
   |                     "routing_key": "dataStorages_app_posgresql_consume"              |
   |                                                                                      |
   |                    # Также могут быть указаны любые другие ключи, которые            |
   |                    # указываются в документации на конкретный сервис хранилища и     |
   |                    # интерпретируются самим сервисом.                                |
   |                },                                                                    |
   |                # Ключ активности хранилища. По умолчанию = True.                     |
   |                "prsActive": true                                                     |
   |           },                                                                         |
   |           "linkTags": [                                                              |
   |                {                                                                     |
   |                    "id": "<tag_id>",                                                 |
   |                    "attributes": {                                                   |
   |                        # Некоторая строка, интерпретируемая хранилищем.              |
   |                        # В случае VitoriaMetrics может содержать имя метрики и теги. |
   |                        "prsStore": "<some str>"                                      |
   |                    }                                                                 |
   |            ],                                                                        |
   |           "linkAlerts": [                                                            |
   |                {                                                                     |
   |                    "id": "<alert_id>",                                               |
   |                    "attributes": {                                                   |
   |                        # Некоторая строка, интерпретируемая хранилищем.              |
   |                        "prsStore": {                                                 |
   |                        }                                                             |
   |                    }                                                                 |
   |            ]                                                                         |
   |        }                                                                             |
   |     }                                                                                |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело ответа</a></summary>                                            |
   |                                                                                      |
   |  .. code:: python                                                                    |
   |                                                                                      |
   |     {                                                                                |
   |           "id": "<new_dataStorage_id>"                                               |
   |     }                                                                                |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   +-----------+----------------------------------+-----+---------------------------------+
   | read      | <dataStorages>_api_crud_publish  | `+` | dataStorages_model_crud,        |
   |           |                                  |     | всем подписанным сервисам       |
   +-----------+----------------------------------+-----+---------------------------------+
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     <details>                                                                        |
   |     <summary><a>Описание</a></summary>                                               |
   |                                                                                      |
   |     Типовая команда чтения данных о узлах.                                           |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело сообщения</a></summary>                                         |
   |                                                                                      |
   |  .. code-block:: python                                                              |
   |                                                                                      |
   |     {                                                                                |
   |        "action": "read",                                                             |
   |        "data": {                                                                     |
   |            "id": ["first_id", "n_id"],                                               |
   |            "scope": 1,                                                               |
   |            "filter": {                                                               |
   |                "prsActive": [true]                                                   |
   |            },                                                                        |
   |            "attributes": ["cn", "description"]                                       |
   |        },                                                                            |
   |        "getLinkedTags": true,                                                        |
   |        "getLinkedAlerts": true                                                       |
   |    }                                                                                 |
   |                                                                                      |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело ответа</a></summary>                                            |
   |                                                                                      |
   |  .. code:: python                                                                    |
   |                                                                                      |
   |     {                                                                                |
   |           "data": [                                                                  |
   |                {                                                                     |
   |                    "id": "<dataStorage_id>",                                         |
   |                    "attributes": {                                                   |
   |                        "cn": "<name>"                                                |
   |                    },                                                                |
   |                    "linkedTags": [                                                   |
   |                        {                                                             |
   |                            "id": "<tag_id>",                                         |
   |                            "attributes": {                                           |
   |                                "prsStore": {                                         |
   |                                }                                                     |
   |                            }                                                         |
   |                        }                                                             |
   |                    ],                                                                |
   |                    "linkedAlerts": [                                                 |
   |                        {                                                             |
   |                            "id": "<alert_id>",                                       |
   |                            "attributes": {                                           |
   |                                "prsStore": {                                         |
   |                                }                                                     |
   |                            }                                                         |
   |                        }                                                             |
   |                    ]                                                                 |
   |                }                                                                     |
   |           ]                                                                          |
   |     }                                                                                |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   +-----------+----------------------------------+-----+---------------------------------+
   | update    | <dataStorages>_api_crud_publish  | `+` | dataStorages_model_crud,        |
   |           |                                  |     | всем подписанным сервисам       |
   +-----------+----------------------------------+-----+---------------------------------+
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     <details>                                                                        |
   |     <summary><a>Описание</a></summary>                                               |
   |                                                                                      |
   |     Типовая команда обновления данных о узлах.                                       |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело сообщения</a></summary>                                         |
   |                                                                                      |
   |  .. code-block:: python                                                              |
   |                                                                                      |
   |     {                                                                                |
   |        "action": "update",                                                           |
   |        "data": {                                                                     |
   |            "id": ["first_id", "n_id"],                                               |
   |            "scope": 1,                                                               |
   |            "filter": {                                                               |
   |                "prsActive": [true]                                                   |
   |            },                                                                        |
   |            "attributes": ["cn", "description"]                                       |
   |        },                                                                            |
   |        "getLinkedTags": true,                                                        |
   |        "getLinkedAlerts": true                                                       |
   |    }                                                                                 |
   |                                                                                      |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   |     <br/>                                                                            |
   |     <details>                                                                        |
   |     <summary><a>Тело ответа</a></summary>                                            |
   |                                                                                      |
   |  .. code:: python                                                                    |
   |                                                                                      |
   |     {                                                                                |
   |           "data": [                                                                  |
   |                {                                                                     |
   |                    "id": "<dataStorage_id>",                                         |
   |                    "attributes": {                                                   |
   |                        "cn": "<name>"                                                |
   |                    },                                                                |
   |                    "linkedTags": [                                                   |
   |                        {                                                             |
   |                            "id": "<tag_id>",                                         |
   |                            "attributes": {                                           |
   |                                "prsStore": {                                         |
   |                                }                                                     |
   |                            }                                                         |
   |                        }                                                             |
   |                    ],                                                                |
   |                    "linkedAlerts": [                                                 |
   |                        {                                                             |
   |                            "id": "<alert_id>",                                       |
   |                            "attributes": {                                           |
   |                                "prsStore": {                                         |
   |                                }                                                     |
   |                            }                                                         |
   |                        }                                                             |
   |                    ]                                                                 |
   |                }                                                                     |
   |           ]                                                                          |
   |     }                                                                                |
   |                                                                                      |
   |  .. raw:: html                                                                       |
   |                                                                                      |
   |     </details>                                                                       |
   +-----------+----------------------------------+-----+---------------------------------+

dataStorages_model_crud
"""""""""""""""""""""""
Сервис реализует команды **CRUD** для сущности ``dataStorages`` (хранилища
данных).

**Publish**


**Consume**

Все сообщения для сервиса приходят в очередь ``<сущность>_model_crud_consume``,
``routing_key = <сущность>_model_crud_consume``.

.. table:: Сообщения, обрабатываемые сервисом ``<сущность>_model_crud``

   +-------------+-----+--------------------------------------------------------------------+
   |  action     | RPC | Описание                                                           |
   +=============+=====+====================================================================+
   | subscribe   | `-` | Сообщение приходит от другого сервиса, который заинтересован |br|  |
   |             |     | в получении уведомлений о изменении/удалении определённых узлов    |
   +-------------+-----+--------------------------------------------------------------------+
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     <details>                                                                          |
   |     <summary><a>Тело сообщения</a></summary>                                           |
   |                                                                                        |
   |  .. code:: python                                                                      |
   |                                                                                        |
   |     {                                                                                  |
   |        "action": "subscribe",                                                          |
   |        "data": {                                                                       |
   |              "routing_key": "<some_routing_key>"                                       |
   |              "id": ["<id_1>", "id_2"]                                                  |
   |        }                                                                               |
   |     }                                                                                  |
   |                                                                                        |
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     </details>                                                                         |
   |     <br/>                                                                              |
   +-------------+-----+--------------------------------------------------------------------+
   | unsubscribe | `-` | Сообщение приходит от другого сервиса, который сообщает |br|       |
   |             |     | об отказе в получении уведомлений о изменении/удалении узлов       |
   +-------------+-----+--------------------------------------------------------------------+
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     <details>                                                                          |
   |     <summary><a>Тело сообщения</a></summary>                                           |
   |                                                                                        |
   |  .. code:: python                                                                      |
   |                                                                                        |
   |     {                                                                                  |
   |        "action": "unsubscribe",                                                        |
   |        "data": {                                                                       |
   |              "routing_key": "<some_routing_key>"                                       |
   |              "id": ["<id_1>", "id_2"]                                                  |
   |        }                                                                               |
   |     }                                                                                  |
   |                                                                                        |
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     </details>                                                                         |
   |     <br/>                                                                              |
   +-------------+-----+--------------------------------------------------------------------+

dataStorages_app_<тип базы данных>
""""""""""""""""""""""""""""""""""
Сервис реализует главную функциональность хранилища.

**Publish**


**Consume**

Все сообщения для сервиса приходят в очередь ``<сущность>_model_crud_consume``,
``routing_key = <сущность>_model_crud_consume``.

.. table:: Сообщения, обрабатываемые сервисом ``<сущность>_model_crud``

   +-------------+-----+--------------------------------------------------------------------+
   |  action     | RPC | Описание                                                           |
   +=============+=====+====================================================================+
   | subscribe   | `-` | Сообщение приходит от другого сервиса, который заинтересован |br|  |
   |             |     | в получении уведомлений о изменении/удалении определённых узлов    |
   +-------------+-----+--------------------------------------------------------------------+
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     <details>                                                                          |
   |     <summary><a>Тело сообщения</a></summary>                                           |
   |                                                                                        |
   |  .. code:: python                                                                      |
   |                                                                                        |
   |     {                                                                                  |
   |        "action": "subscribe",                                                          |
   |        "data": {                                                                       |
   |              "routing_key": "<some_routing_key>"                                       |
   |              "id": ["<id_1>", "id_2"]                                                  |
   |        }                                                                               |
   |     }                                                                                  |
   |                                                                                        |
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     </details>                                                                         |
   |     <br/>                                                                              |
   +-------------+-----+--------------------------------------------------------------------+
   | unsubscribe | `-` | Сообщение приходит от другого сервиса, который сообщает |br|       |
   |             |     | об отказе в получении уведомлений о изменении/удалении узлов       |
   +-------------+-----+--------------------------------------------------------------------+
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     <details>                                                                          |
   |     <summary><a>Тело сообщения</a></summary>                                           |
   |                                                                                        |
   |  .. code:: python                                                                      |
   |                                                                                        |
   |     {                                                                                  |
   |        "action": "unsubscribe",                                                        |
   |        "data": {                                                                       |
   |              "routing_key": "<some_routing_key>"                                       |
   |              "id": ["<id_1>", "id_2"]                                                  |
   |        }                                                                               |
   |     }                                                                                  |
   |                                                                                        |
   |  .. raw:: html                                                                         |
   |                                                                                        |
   |     </details>                                                                         |
   |     <br/>                                                                              |
   +-------------+-----+--------------------------------------------------------------------+
